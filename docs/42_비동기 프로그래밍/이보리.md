# 42장 비동기 프로그래밍

## 📂 42.1 동기 처리와 비동기 처리
- 자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.
  - 실행 컨텍스트 스택의 최상위 요소인 "실행 중인 실행 컨텍스트"를 제외한 모든 실행 컨텍스트는 모두 실행 대기 중인 태스크들이다.
  - 대기 중인 태스크들은 현재 실행 중인 실행 컨텍스트가 팝되어 실행 컨텍스트 스택에서 제거되면, 비로소 실행된다.
- **싱글 스레드<sup>single thread</sup>** : 한 번에 하나의 태스크만 실행
  - 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹<sup>blocking</sup>(작업 중단)이 발생

#### 동기<sup>synchronous</sup> 처리
- 현재 실행 중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식
- 장점 : 태스크를 순서대로 하나씩 처리하므로 실행 순서 보장
- 단점 : 태스크가 종료할 떄까지 이후 태스크들이 블로킹

![](https://i.imgur.com/9Vhtd29.png)

#### 비동기<sup>asynchronous</sup> 처리
- 현재 실행 중인 태스크가 종료되지 않은 상태라 해도 다음 태스크를 곧바로 실행하는 방식
- 장점 : 블로킹이 발생하지 않음
- 단점 : 태스크 순서가 보장되지 않음
- `setTimeout`, `setInterval`, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작

![](https://i.imgur.com/CdbT6wc.png)

## 📂 42.2 이벤트 루프와 태스크 큐
- 자바스크립트는 싱글 스레드로 동작하지만 브라우저가 동작하는 것을 보면 태스크가 동시에 처리되는 것처럼 느껴진다.
- 자바트스립트의 동시성<sup>concurrency</sup>을 지원하는 것 ⇒ **이벤트 루프<sup>event loop</sup>**

![](https://i.imgur.com/DSf3c2j.png)

> #### 자바스크립트 엔진
> - 콜 스택<sup>call stack</sup>
>   - 소스코드 평가 과정에서 생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조인 실행 컨텍스트 스택
>   - 함수를 호출하면 함수 실행 컨텍스트가 순차적으로 콜 스택에 푸시되어 순차적으로 실행
>   - 최상휘 실행 컨텍스트(실행 중인 실행 컨텍스트)가 종료되어 콜 스택에서 제거되기 전까지 다른 어떤 태스크도 실행되지 않는다.
> - 힙<sup>heap</sup>
>   - 객체가 저장되는 메모리 공간으로 콜 스택의 요소인 실행 컨텍스트는 힙에 저장된 객체를 참조
>   - 메모리에 값을 저장하려면 먼저 값을 저장할 메모리 공간의 크기를 결정
>   - 객체는 크기가 정해져 있지 않아 할당해야 할 메모리 공간의 크기를 런타임에 결정(동적 할당)
>   - 힙은 구조화 되어있지 않다는 특징을 가짐

- 이와 같이 자바스크립트 엔진은 단순히 작업이 요청되면 콜 스택을 사용하여 요청된 작업을 순차적으로 실행
⇒ 동시성을 지원하기 위해 필요한 비동기 요청(이벤트를 포함) 처리는 자바스크립트 엔진을 구동하는 환경인 브라우저 또는 Node.js 가 담당
  - 태스크 큐<sup>task queue/event queue/callback queue</sup>
    - 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역
  - 이벤트 루프
    - 콜 스택 내에 현재 실행중인 태스크가 있는지 그리고 태스크 큐에 대기 중인 태스크가 있는지 반복 확인
    - 만약 콜 스택이 비어있다면 태스크 큐에 대기 중인 태스크 있다면 이벤트 루프는 순차적으로 태스크 큐에 대기 중인 태스크를 콜 스택으로 이동시키고, 콜 스택으로 이동한 태스크는 실행된다.

#### 브라우저
- 자바스크립트는 싱글 스레드 방식으로 동작하지만 **브라우저는 멀티 스레드로 동작**
  - 자바스크립트 엔진은 브라우저에 내장되어 있음
- 브라우저는 자바스크립트 엔진 외에도 렌더링 엔진과 Web API 제공
- Web API
  - ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API
  - DOM API와 타이머 함수, HTTP 요청(ajax)과 같은 비동기 처리를 포함
- 브라우저와 자바스크립트 엔진이 협력하여 비동기 함수 실행