## 🔖 38장 - 브라우저의 렌더링 과정

```
대부분의 프로그래밍 언어는 운영체제나 가상 머신 위에서 실행되지만
웹 애플리케이션의 클라이언트 사이드 자바스크립트는 브라우저에서 HTML, CSS와 함께 실행된다.
따라서 브라우저 환경을 고려할 때 더 효율적인 클라이언트 사이드 자바스크립트 프로그래밍이 가능하다.
```

❓ 브라우저가 HTML, CSS, 자바스크립트로 작성된 텍스트 문서를 어떻게 [파싱](#info)(해석)하여 브라우저에 [렌더링](#info) 할까?

1. 브라우저는 HTML, CSS, 자바스크립트, 이미지, 폰트 파일 등 렌더링에 필요한 리소스를 요청하고 서버로부터 응답을 받는다.
2. 브라우저의 렌더링 엔진은 서버로부터 응답된 HTML과 CSS를 파싱하여 DOM과 CSSOM을 생성하고 이들을 결합하여 렌더 트리를 생성한다.
3. 브라우저의 자바스크립트 엔진은 서버로부터 응답된 자바스크립트를 파싱하여 AST<sup>Abstract Syntax Tree</sup>를 생성하고 바이트코드로 변환하여 실행한다.
   1. 이때 자바스크립트는 DOM API를 통해 DOM이나 CSSOM을 변경할 수 있다. 변경된 DOM과 CSSOM은 다시 렌더 트리로 결합된다.
4. 렌더 트리를 기반으로 HTML 요소의 레이아웃(위치와 크기)을 계산하고 브라우저 화면에 HTML 요소를 페인팅한다.

## 요청과 응답

📌 브라우저의 핵심 기능은 필요한 리소스(HTML, CSS, 자바스크립트, 이미지, 폰트 등의 정적 파일 또는 서버가 동적으로 생성한 데이터)를
서버에 요청<sup>request</sup>하고 서버로부터 응답<sup>response</sup>받아 브라우저에 시각적으로 렌더링하는 것이다.

1. 사용자가 브라우저를 통해 웹사이트에 접속한다.
2. 브라우저는 해당 웹사이트의 URL을 서버에 요청한다.
3. 서버는 요청에 대한 응답으로 HTML, CSS, JavaScript 등의 리소스를 보낸다.
    > 브라우저의 렌더링 엔진이 HTML(index.html)을 파싱하는 도중에 외부 리소스를 로드하는 태그,
     즉 CSS 파일을 로드하는 link 태그, 이미지 파일을 로드하는 img 태그, 자바스크립트를 로드하는 script 태그 등을 만나면
     HTML의 파싱을 중단하고 해당 리소스 파일을 서버로 요청한다.   
4. 브라우저는 서버로부터 받은 리소스를 파싱하고 렌더링하여 사용자에게 화면에 보여준다.
5. 사용자는 브라우저를 통해 웹사이트와 상호작용합니다. 예를 들어, 링크를 클릭하거나 폼을 제출한다.
6. 브라우저는 이러한 상호작용에 대한 요청을 서버에 보내고, 서버는 요청에 대한 응답으로 새로운 HTML, CSS, JavaScript 등의 리소스를 보낸다.
7. 브라우저는 새로운 리소스를 파싱하고 렌더링하여 사용자에게 화면에 보여준다.
8. 이러한 과정은 사용자가 웹사이트를 사용하는 동안 계속해서 반복된다.

> 브라우저와 서버 간의 이러한 요청과 응답 과정은 HTTP<sup>Hypertext Transfer Protocol</sup> 프로토콜을 이용하여 이루어진다.
> 요청과 응답은 HTTP 메시지를 이용하여 전송되며, 이를 위해 브라우저와 서버는 HTTP 요청 메서드(GET, POST 등), HTTP 상태 코드(200 OK, 404 Not Found 등) 등의 정보를 주고 받는다.

## HTML 파싱과 DOM 생성

📌 HTML 파싱은 브라우저가 HTML 문서를 읽고 브라우저가 이해할 수 있는 구조인 DOM<sup>Document Object Model</sup> 트리로 변환하는 과정이다.

📎 HTML 파싱 단계

1. 토큰화<sup>Tokenization</sup>

    HTML 문서를 문자열 형태로 받아들인 뒤, 각각의 문자열을 의미 있는 단위인 토큰<sup>token</sup>으로 분해한다.
    > 토큰은 여는 태그, 닫는 태그, 속성 등과 같은 HTML 요소를 표현한다.

2. 토큰을 요소로 변환<sup>Conversion to Elements</sup>

    각각의 토큰을 분석하여 요소<sup>element</sup>로 변환한다. 이 과정에서 각 요소의 관계도 파악하게 된다.

3. DOM 트리 생성

    변환된 요소들은 DOM 트리의 노드로 추가된다. 이때, DOM 트리의 루트는 문서의 최상위 요소인 `<html>` 태그가 된다.
    > DOM은 HTML 문서를 파싱한 결과물이다.

> HTML 파싱은 브라우저가 HTML 문서를 읽어 들여서 DOM 트리로 변환하는 것이기 때문에, 이 과정에서 문제가 발생할 경우 브라우저가 예상한 대로 DOM 트리를 구성할 수 없게 된다.
>
> 예를 들어, 올바르지 않은 HTML 문법이 사용되거나, 브라우저에서 지원하지 않는 태그나 속성이 사용될 경우, DOM 트리가 생성되지 않을 수 있다.
> 이러한 이유로 올바른 HTML 문법을 사용하는 것이 중요하다.

## CSS 파싱과 CSSOM 생성

📌 CSS 파싱은 브라우저가 CSS 파일을 읽어들이고, 이를 기반으로 CSSOM(CSS Object Model) 트리를 생성하는 과정이다.
> 이 과정은 HTML 파싱과 다르게 브라우저에서 수행된다.

📎 CSS 파싱 과정

1. 브라우저는 HTML 문서를 파싱하다가 `<link>` 태그나 `<style>` 태그를 만나면 DOM 생성을 일시 중단하고 CSS 파일을 로드한다.
2. 로드된 CSS 파일의 내용은 토큰화<sup>tokenization</sup>되어 파싱된다.
   1. 토큰화는 CSS 코드를 의미 있는 작은 단위로 쪼개는 과정이다.
3. CSS 파서는 토큰화된 CSS 코드를 파싱하여 스타일 규칙을 만든다.
   1. 스타일 규칙은 선택자와 스타일 선언부로 구성된다.
4. 브라우저는 이러한 스타일 규칙을 적용하기 위해 CSSOM 트리를 생성한다.
   1. CSSOM 트리는 HTML DOM 트리와 유사하지만, 각 노드의 스타일 정보가 추가로 저장된다.
5. CSSOM 트리와 HTML DOM 트리를 결합하여 렌더 트리<sup>Render Tree</sup>를 생성한다.

> CSS 파싱 과정에서는 다양한 종류의 선택자, 상속, 우선순위 등 다양한 개념이 사용된다.
> 또한, CSSOM 트리를 생성하는 과정에서는 CSS 파일이 매우 크거나, 많은 수의 규칙이 존재할 경우 성능 문제가 발생할 수 있다.
> 이러한 문제를 해결하기 위해서는 CSS 파일을 압축하거나, 필요한 부분만 로드하는 방식 등을 사용할 수 있다.

> CSSOM은 자바스크립트로 조작할 수 있으며, DOM과 마찬가지로 노드의 속성 값을 변경하여 CSS를 동적으로 조작할 수 있다.
> 이를 통해 CSS 애니메이션, 스타일 변경 등 다양한 동적인 효과를 구현할 수 있다.
> 
> ⚠️ 하지만, CSSOM을 변경하는 작업은 리플로우<sup>reflow</sup>와 리페인트<sup>repaint</sup>를 발생시킬 수 있으므로, 성능상 주의해야 한다.

## 렌더 트리 생성

📌 렌더 트리<sup>render tree</sup>는 브라우저가 HTML 문서와 CSS 스타일 규칙을 이용하여 계산한, 화면에 표시될 요소로 이루어진 트리 구조이다.
렌더 트리는 DOM 트리와 CSSOM 트리 정보를 결합하여 생성된다.

브라우저 화면에 렌더링되지 않는 노드(예: meta 태그, script 태그 등)와 CSS에 의해 비표시(예: display: none)되는 노드들은 포함하지 않는다.

> ⚠️ `visibility: hidden`은 요소가 공간을 차지하고, 보이지만 않기 때문에 렌더 트리에 포함된다.

이후 완성된 렌더 트리는 각 HTML 요소의 레이아웃을 계산하는 데 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인팅<sup>painting</sup> 처리에 입력된다.

> ⚠️ 리렌더링은 비용이 많이 드는, 즉 성능에 악영향을 주는 작업이다. 따라서 가급적 리렌더링이 빈번하게 발생하지 않도록 주의할 필요가 있다.

## 자바스크립트 파싱과 실행

```
CSS 파싱 과정과 마찬가지로 렌더링 엔진은 HTML을 한 줄씩 순차적으로 파싱하며 DOM을 생성해 나가다가
자바스크립트 파일을 로드하는 script 태그나 자바스크립트 코드를 콘텐츠로 담은 script 태그를 만나면 DOM 생성을 일시 중단한다.
```

📌 자바스크립트 파싱과 실행은 브라우저의 렌더링 엔진이 아닌 자바스크립트 엔진이 처리한다.

1. 토크나이징<sup>tokenizing</sup>

    단순한 문자열인 자바스크립트 소스코드를 어휘 분석<sup>lexical analysis</sup>하여 문법적 의미를 갖는 코드의 최소 단위인 토큰<sup>token</sup>들로 분해한다.

2. 파싱<sup>parsing</sup>

    토큰들의 집합을 구문 분석<sup>syntactic analysis</sup>하여 **AST<sup>Abstract Syntax Tree</sup>(추상적 구문 트리)** 를 생성한다.
    AST는 토큰에 문법적 의미와 구조를 반영한 트리 구조의 자료구조다.
    AST는 인터프리터나 컴파일러만이 사용하는 것은 아니다.

3. 바이트코드 생성과 실행

    파싱의 결과물로서 생성된 AST는 인터프리터가 실행할 수 있는 중간 코드인 바이트코드로 변환되고 인터프리터에 의해 실행된다. 

## 리플로우와 리페인트

```
리플로우와 리페인트는 브라우저에서 HTML과 CSS를 렌더링하는 과정에서 발생하는 작업이다.
```

📌 리플로우<sup>reflow</sup>는 레이아웃을 재계산하는 과정을 의미한다.

레이아웃을 재계산해야 하는 이유는, HTML 요소의 크기나 위치 등이 변경되거나, 새로운 요소가 추가되는 등의 변화가 발생했을 때, 이에 맞춰 레이아웃을 다시 계산해야 하기 때문이다.
리플로우 과정은 매우 비싼 작업으로, 브라우저 성능에 영향을 미칠 수 있다.

> 예를 들어, CSS 속성 중에서 `width`, `height`, `margin`, `padding` 등과 같은 박스 모델(Box Model)과 관련된 속성이 변경되었을 때, 리플로우가 발생한다.

📌 리페인트<sup>repaint</sup>는 요소의 스타일이 변경되었을 때, 해당 요소를 다시 그리는 과정을 의미한다.

리페인트는 리플로우보다는 비교적 덜 비싼 작업으로, 브라우저 성능에 큰 영향을 미치지 않는다.

> 예를 들어, CSS 속성 중에서 `color`, `background-color`, `border` 등과 같은 스타일 속성이 변경되었을 때, 해당 요소의 리페인트가 발생한다.

## 자바스크립트 파싱에 의한 HTML 파싱 중단

```
브라우저 렌더링 과정에서 HTML 파싱 및 JavaScript 파싱 단계는 동시에 실행될 수 있다.
그러나 HTML 파싱 과정 중에 실행되는 JavaScript 코드는 HTML 파싱을 중단하여 예기치 않거나 일관되지 않은 결과를 초래할 수 있다.
```

브라우저가 HTML 문서에서 `<script>` 태그를 만나면 일반적으로 HTML 파싱 과정을 일시 중지하고 JavaScript 파싱 모드로 전환하여 JavaScript 코드를 실행한다.
JavaScript 코드 실행이 완료되면 브라우저는 중단된 지점부터 HTML 파싱 과정을 다시 시작한다.

JavaScript 코드가 DOM 또는 CSSOM을 수정하면 리플로우 또는 리페인트가 트리거되어 웹 페이지의 렌더링 성능에 상당한 영향을 미칠 수 있다.
또한 JavaScript 코드를 실행하는 데 시간이 오래 걸리거나 무한 루프가 포함된 경우 HTML 파싱 과정이 무기한 중단되어 웹 페이지가 비어 있거나 부분적으로 렌더링될 수 있다.

❓ HTML 파싱 과정에서 JavaScript의 영향을 최소화하려면
1. JavaScript 코드를 HTML 문서의 맨 아래 닫는 `</body>` 태그 바로 앞에 두는 것이 좋다.
   - 이렇게 하면 JavaScript 코드가 실행되기 전에 HTML 파싱 과정이 완료되어 파싱 과정이 중단될 위험이 줄어든다.
2. `<script>` 태그에서 async 또는 defer 속성을 사용할 수 있다.
   - async 속성은 HTML 파싱 과정을 일시 중지하지 않고 스크립트를 비동기적으로 다운로드하고 실행하도록 브라우저에 지시한다.
   - defer 속성은 스크립트를 비동기적으로 다운로드하지만 HTML 파싱 과정이 완료될 때까지 실행을 연기하도록 브라우저에 지시한다.

<a id="info"></a>
## 개념 정리 📝

| 단어                      | 설명                                                                                                                       |
|-------------------------|--------------------------------------------------------------------------------------------------------------------------|
| 파싱<sup>parsing          | 프로그래밍 언어의 문법에 맞게 작성된 텍스트 문서를 읽어 들여 실행하기 위해 텍스트 문서의 문자열을 토큰으로 분해하고, 토큰에 문법적 의미와 구조를 반영하여 트리 구조의 자료구조인 파스 트리를 생성하는 일련의 과정  |
| 렌더링<sup>rendering</sup> | HTML, CSS, 자바스크립트로 작성된 문서를 파싱하여 브라우저에 시각적으로 출력하는 것                                                                       |
